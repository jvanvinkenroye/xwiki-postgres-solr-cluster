# XWiki High Availability Cluster Configuration
# PostgreSQL + Solr + Multiple XWiki Nodes + Load Balancer
# See: clustering/README.md for setup instructions

networks:
  xwiki-cluster-network:
    driver: bridge
    name: xwiki-cluster-network

volumes:
  # PostgreSQL data persistence
  postgres-data:
    name: xwiki-cluster-postgres-data

  # Shared XWiki permanent directory (required for clustering)
  # In production, use NFS or other shared storage
  xwiki-data-shared:
    name: xwiki-cluster-data-shared

  # Solr index data persistence
  solr-data:
    name: xwiki-cluster-solr-data

services:
  # PostgreSQL Database Service (Shared by all nodes)
  db:
    image: postgres:17
    container_name: xwiki-cluster-db
    restart: unless-stopped

    networks:
      - xwiki-cluster-network

    volumes:
      - postgres-data:/var/lib/postgresql/data

    environment:
      POSTGRES_ROOT_PASSWORD: ${POSTGRES_ROOT_PASSWORD:-xwiki}
      POSTGRES_USER: ${POSTGRES_USER:-xwiki}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-xwiki}
      POSTGRES_DB: ${POSTGRES_DB:-xwiki}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale-provider=builtin --locale=C.UTF-8"

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U xwiki"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    # Production: Tune PostgreSQL for multiple connections
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"

  # Solr Initialization Service
  # Sets up XWiki Solr cores using official configurations from Maven
  solr-init:
    image: alpine:latest
    container_name: xwiki-solr-init
    restart: "no"  # Runs once, then exits

    volumes:
      # Source: Official XWiki Solr core configurations (downloaded from Maven)
      - ./solr-cores-official:/source:ro

      # Target: Shared volume with Solr
      - solr-data:/target

    # Setup all required Solr cores with official configurations
    command: |
      sh -c '
        echo "ðŸš€ Setting up XWiki Solr cores with official configurations..."

        # Check if already setup
        if [ -d "/target/data/xwiki_search_9" ] && [ -f "/target/data/xwiki_search_9/core.properties" ]; then
          echo "âœ… Solr cores already configured"
          exit 0
        fi

        # Create main search core (xwiki_search_9)
        echo "ðŸ“¦ Setting up xwiki_search_9 (main search core)..."
        mkdir -p /target/data/xwiki_search_9
        cp -r /source/conf /target/data/xwiki_search_9/
        cp -r /source/lib /target/data/xwiki_search_9/
        echo "name=xwiki_search_9" > /target/data/xwiki_search_9/core.properties

        # Create ConfigSet from search core for dynamic core creation
        echo "ðŸ”§ Creating ConfigSet xwiki..."
        mkdir -p /target/data/configsets/xwiki
        cp -r /source/conf /target/data/configsets/xwiki/
        if [ -d /source/lib ]; then
          cp -r /source/lib /target/data/configsets/xwiki/
        fi

        # Create additional cores with minimal configuration
        echo "ðŸ“¦ Setting up additional cores (extension_index, events, ratings)..."
        for core_name in xwiki_extension_index_9 xwiki_events_9 xwiki_ratings_9; do
          echo "  Creating $$core_name..."
          mkdir -p /target/data/$$core_name
          cp -r /source/minimal/conf /target/data/$$core_name/
          echo "name=$$core_name" > /target/data/$$core_name/core.properties
        done

        # Set correct permissions for Solr user (8983:8983)
        echo "ðŸ”§ Setting permissions for Solr user..."
        chown -R 8983:8983 /target/data

        echo "âœ… All Solr cores configured successfully!"
        echo ""
        echo "Configured cores:"
        ls -1 /target/data/ | grep xwiki
      '

  # Apache Solr Search Service (Shared by all nodes)
  solr:
    image: solr:9  # Official Solr image (no custom build needed!)
    container_name: xwiki-cluster-solr
    restart: unless-stopped

    # Wait for solr-init to complete
    depends_on:
      solr-init:
        condition: service_completed_successfully

    networks:
      - xwiki-cluster-network

    volumes:
      # Only the Solr data volume (core is extracted by solr-init)
      - solr-data:/var/solr

    environment:
      SOLR_HEAP: ${SOLR_HEAP:-1g}
      # Enable analysis-extras module (required for XWiki's advanced language analyzers)
      SOLR_MODULES: analysis-extras
      # Set default configSet for new cores
      SOLR_OPTS: "-Dsolr.configset.default=xwiki"
      # Production: Enable Solr authentication
      # SOLR_AUTH_TYPE: basic
      # SOLR_AUTHENTICATION_OPTS: "-Dbasicauth=solr:SolrRocks"

    # Only expose for debugging (remove in production)
    ports:
      - "8983:8983"

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8983/solr/xwiki_search_9/admin/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # XWiki Node 1
  web1:
    image: xwiki:${XWIKI_VERSION:-stable-postgres-tomcat}
    container_name: xwiki-cluster-node1
    hostname: xwiki-node1
    restart: unless-stopped

    depends_on:
      db:
        condition: service_healthy
      solr:
        condition: service_healthy

    networks:
      - xwiki-cluster-network

    volumes:
      # Shared permanent directory (CRITICAL for clustering)
      - xwiki-data-shared:/usr/local/xwiki

      # JGroups clustering configuration
      - ./jgroups/tcp.xml:/usr/local/tomcat/webapps/ROOT/WEB-INF/observation/remote/jgroups/tcp.xml:ro

      # XWiki configuration (required for Solr remote connection)
      - ./config/xwiki.properties:/usr/local/tomcat/webapps/ROOT/WEB-INF/xwiki.properties

    environment:
      # Database connection
      DB_USER: ${POSTGRES_USER:-xwiki}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-xwiki}
      DB_DATABASE: ${POSTGRES_DB:-xwiki}
      DB_HOST: xwiki-cluster-db

      # Solr configuration
      INDEX_HOST: xwiki-cluster-solr
      INDEX_PORT: 8983

      # JVM options for clustering
      JAVA_OPTS: >-
        -Xmx2048m
        -Xms1024m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -Dfile.encoding=UTF-8
        -Djava.awt.headless=true
        -Djgroups.bind_addr=xwiki-node1
        -Djgroups.tcp.address=xwiki-node1

    # Do NOT expose port externally - use load balancer
    expose:
      - "8080"

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # XWiki Node 2
  web2:
    image: xwiki:${XWIKI_VERSION:-stable-postgres-tomcat}
    container_name: xwiki-cluster-node2
    hostname: xwiki-node2
    restart: unless-stopped

    depends_on:
      db:
        condition: service_healthy
      solr:
        condition: service_healthy
      web1:
        condition: service_healthy

    networks:
      - xwiki-cluster-network

    volumes:
      # Same shared permanent directory
      - xwiki-data-shared:/usr/local/xwiki

      # JGroups clustering configuration
      - ./jgroups/tcp.xml:/usr/local/tomcat/webapps/ROOT/WEB-INF/observation/remote/jgroups/tcp.xml:ro

      # XWiki configuration (required for Solr remote connection)
      - ./config/xwiki.properties:/usr/local/tomcat/webapps/ROOT/WEB-INF/xwiki.properties

    environment:
      DB_USER: ${POSTGRES_USER:-xwiki}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-xwiki}
      DB_DATABASE: ${POSTGRES_DB:-xwiki}
      DB_HOST: xwiki-cluster-db

      INDEX_HOST: xwiki-cluster-solr
      INDEX_PORT: 8983

      JAVA_OPTS: >-
        -Xmx2048m
        -Xms1024m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -Dfile.encoding=UTF-8
        -Djava.awt.headless=true
        -Djgroups.bind_addr=xwiki-node2
        -Djgroups.tcp.address=xwiki-node2

    expose:
      - "8080"

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # XWiki Node 3 (Optional - scale as needed)
#   web3:
#     image: xwiki:${XWIKI_VERSION:-stable-postgres-tomcat}
#     container_name: xwiki-cluster-node3
#     hostname: xwiki-node3
#     restart: unless-stopped
# 
#     depends_on:
#       db:
#         condition: service_healthy
#       solr:
#         condition: service_healthy
#       web1:
#         condition: service_healthy
# 
#     networks:
#       - xwiki-cluster-network
# 
#     volumes:
#       - xwiki-data-shared:/usr/local/xwiki
#       - ./jgroups/tcp.xml:/usr/local/tomcat/webapps/ROOT/WEB-INF/observation/remote/jgroups/tcp.xml:ro
# 
#     environment:
#       DB_USER: ${POSTGRES_USER:-xwiki}
#       DB_PASSWORD: ${POSTGRES_PASSWORD:-xwiki}
#       DB_DATABASE: ${POSTGRES_DB:-xwiki}
#       DB_HOST: xwiki-cluster-db
# 
#       INDEX_HOST: xwiki-cluster-solr
#       INDEX_PORT: 8983
# 
#       JAVA_OPTS: >-
#         -Xmx2048m
#         -Xms1024m
#         -XX:+UseG1GC
#         -XX:MaxGCPauseMillis=200
#         -Dfile.encoding=UTF-8
#         -Djava.awt.headless=true
#         -Djgroups.bind_addr=xwiki-node3
#         -Djgroups.tcp.address=xwiki-node3
# 
#     expose:
#       - "8080"
# 
#     healthcheck:
#       test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
#       interval: 30s
#       timeout: 10s
#       retries: 5
#       start_period: 120s
#
#     # Optional: Disable this node by default (scale on demand)
#     # profiles:
#     #   - scale

  # Nginx Load Balancer
  loadbalancer:
    image: nginx:1.27-alpine
    container_name: xwiki-cluster-lb
    restart: unless-stopped

    depends_on:
      web1:
        condition: service_healthy
      web2:
        condition: service_healthy

    networks:
      - xwiki-cluster-network

    ports:
      # Main access point
      - "${XWIKI_PORT:-8080}:80"
      # Nginx status page
      - "${NGINX_STATUS_PORT:-8081}:8080"

    volumes:
      # Main nginx configuration
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # Upstream (backend servers) configuration
      - ./nginx/upstream.conf:/etc/nginx/conf.d/upstream.conf:ro
      # Virtual host configuration
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      # Status page configuration
      - ./nginx/status.conf:/etc/nginx/conf.d/status.conf:ro
      # Log directory (optional - for persistent logs)
      # - ./logs/nginx:/var/log/nginx

    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Optional: Resource limits
    # deploy:
    #   resources:
    #     limits:
    #       memory: 512M
    #     reservations:
    #       memory: 256M
