# XWiki Cluster Upstream Configuration
# Defines backend servers and load balancing strategy

# XWiki backend cluster
upstream xwiki_backend {
    # Load balancing method
    # Options:
    #   - (none): Round-robin (default)
    #   - least_conn: Route to server with least active connections
    #   - ip_hash: Hash client IP for sticky sessions (basic)
    #   - hash $cookie_JSESSIONID consistent: Hash session cookie (better sticky sessions)

    # Use session cookie for sticky sessions (CRITICAL for XWiki)
    # This ensures users stay on the same server throughout their session
    hash $cookie_JSESSIONID consistent;

    # Alternative: Use IP-based sticky sessions (less reliable with proxies/NAT)
    # ip_hash;

    # XWiki Node 1
    server xwiki-cluster-node1:8080 max_fails=3 fail_timeout=30s;

    # XWiki Node 2
    server xwiki-cluster-node2:8080 max_fails=3 fail_timeout=30s;

    # XWiki Node 3 (commented out - enable web3 in docker-compose first)
    # server xwiki-cluster-node3:8080 max_fails=3 fail_timeout=30s;

    # Backup server (optional - only used when all primary servers are down)
    # server xwiki-cluster-backup:8080 backup;

    # Connection keepalive to backend servers
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# Health check upstream (lightweight, no sticky sessions needed)
upstream health_check {
    server xwiki-cluster-node1:8080;
    server xwiki-cluster-node2:8080;
    # server xwiki-cluster-node3:8080;

    # Simple round-robin for health checks
    # No sticky sessions needed
}
